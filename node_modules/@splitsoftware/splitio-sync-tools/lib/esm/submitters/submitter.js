import { __awaiter } from "tslib";
import { retry } from './utils';
// Base submitter factory for impressions and events submitters, which must handle metadata
export function submitterWithMetadataFactory(logger, postClient, sourceCache, dataName, itemsPerPost, fromCacheToPayload, maxRetries) {
    return function postData() {
        return sourceCache.popNWithMetadata(itemsPerPost).then((cacheData) => __awaiter(this, void 0, void 0, function* () {
            const data = fromCacheToPayload(cacheData);
            // POST data with retry attempts
            try {
                for (let i = 0; i < data.length; i++) {
                    const { payload, headers } = data[i];
                    yield retry(() => postClient(JSON.stringify(payload), headers), maxRetries);
                }
                logger.info(`Successfully submitted ${dataName} to Split`);
            }
            catch (err) {
                logger.error(`An error occurred while submitting ${dataName} to Split: ${err}`);
                return false;
            }
            // If more data is available, post it.
            const count = yield sourceCache.count();
            return count > 0 ? postData() : true;
        }))
            .catch((e) => {
            logger.error(`An error occurred while retrieving ${dataName} from storage: ${e}`);
            return false;
        });
    };
}
// Base submitter factory for impression counts and unique keys submitters
export function submitterFactory(logger, postClient, getPayload, dataName, maxRetries) {
    return function postData() {
        return __awaiter(this, void 0, void 0, function* () {
            let payload;
            try {
                payload = yield getPayload();
            }
            catch (e) {
                logger.error(`An error occurred when retrieving ${dataName} from storage: ${e}`);
                return false;
            }
            if (payload) {
                // POST data with retry attempts
                try {
                    yield retry(() => postClient(JSON.stringify(payload)), maxRetries);
                    logger.info(`Successfully submitted ${dataName} to Split.`);
                }
                catch (err) {
                    logger.error(`An error occurred while submitting ${dataName} to Split: ${err}`);
                    return false;
                }
            }
            return true;
        });
    };
}
